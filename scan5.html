<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Scan QR Code</title>
  <link rel="manifest" href="manifest.json">
  
  <meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Scan MKS">
<link rel="apple-touch-icon" href="/icon.png">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: black;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }

    #reader {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
}

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(3px);
    }

.modal-content {
  background-color: #fff;
  border-radius: 12px;
  padding: 40px;
  text-align: center;
  box-shadow: 0 10px 25px rgba(0,0,0,0.3);
  width: calc(100vw - 80px);
  height: calc(100vh - 80px);

  display: flex;
  flex-direction: column;
  justify-content: center;
}

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

  .modal-buttons {
  margin-top: 20px;
  display: flex;
  flex-direction: row; /* côte à côte */
  justify-content: center;
  gap: 40px; /* espace entre les boutons */
  padding: 0 40px; /* espace intérieur gauche et droite */
}

.btn {
  padding: 30px 40px; /* réduit le padding horizontal pour mieux gérer la largeur */
  font-size: 3.5rem;
  border: none;
  border-radius: 12px;
  font-weight: bold;
  cursor: pointer;
  transition: background 0.3s;
  flex: 1;
  max-width: 33.33%; /* pour 3 boutons égaux sur la ligne */
  box-sizing: border-box; /* pour inclure padding dans la largeur */
  text-align: center;
}

    .btn-ok {
      background-color: #27ae60;
      color: white;
    }

    .btn-ok:hover {
      background-color: #219150;
    }

    .btn-cancel {
      background-color: #e74c3c;
      color: white;
    }

    .btn-cancel:hover {
      background-color: #c0392b;
    }
	
	
.modal-content p#modalText {
  font-size: 3rem;
  line-height: 1.4;
  margin-bottom: 40px;
}
#reader > div:first-child {
  display: flex !important;
  align-items: center;
  justify-content: center;
  height: 100vh;
}

#reader__scan_region {
  position: relative;
  width: 50vmin;
  height: 50vmin; /* carré parfait */
}

#reader__scan_region > video {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover; /* évite les bandes noires */
}
#scanner-frame {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 50vmin;
  height: 50vmin;
  transform: translate(-50%, -50%);
  border: 4px solid rgba(255, 255, 255, 0.7);
  box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
  z-index: 10;
  border-radius: 8px;
  pointer-events: none;
}

#reader__dashboard_section_csr,
#reader__scan_region > div {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
}
.articles-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
  margin-top: 10px;
}

.article-box {
  border: 2px solid #000;
  border-radius: 12px;
  background-color: #fff;
  height: 240px; /* ⬆️ hauteur augmentée */
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.article-label {
  background-color: #000;
  color: #fff;
  font-size: 4rem; /* légèrement plus grand */
  font-weight: bold;
  padding: 20px 10px; /* plus de hauteur verticale */
  text-align: center;
}

.article-size {
  font-size: 3.5rem;
  color: #333;
  text-align: center;
  padding: 30px 10px; /* augmente l'espace dans la case */
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
}

.missing {
  background-color: #ffdddd !important;
  border-color: red !important;
}

.btn-reprise {
  background-color: orange;
  color: white;
}

.btn-reprise:hover {
  background-color: darkorange;
}

  </style>
</head>
<body>
  <div id="reader"></div>
<div id="scanner-frame"></div>
  <!-- Modal -->
  <div class="modal" id="confirmModal">
    <div class="modal-content">
      <p id="modalText">Commande terminée ?</p>
      <div class="modal-buttons">
  <button class="btn btn-cancel" id="cancelBtn">Annuler</button>
  
  <button class="btn btn-ok" id="okBtn">Terminé</button>
  <button class="btn btn-reprise" id="repriseBtn">Repris</button>
</div>
    </div>
  </div>

  <script>
    let currentOrderId = null;
    let currentEmail = null;

    function showConfirmationModal(orderId, email) {
      currentOrderId = orderId;
      currentEmail = email;
      document.getElementById('modalText').innerHTML = `Commande terminée ?<br>Envoyer un email à : <strong>${email}</strong>`;
      document.getElementById('confirmModal').style.display = 'flex';
    }

    function hideModal() {
      document.getElementById('confirmModal').style.display = 'none';
    }

    document.getElementById('okBtn').addEventListener('click', () => {
  hideModal();
  html5QrCode.stop().then(() => {
    updateOrderCompleted(currentOrderId, currentEmail, () => {
      sendCompletionEmail(currentOrderId, currentEmail);
      restartScanner(); // Redémarrage après les opérations
    });
  }).catch(console.error);
});


    document.getElementById('cancelBtn').addEventListener('click', () => {
  hideModal();
  html5QrCode.stop().then(() => {
    restartScanner();
  }).catch(err => {
    console.error("Erreur à l'arrêt du scan :", err);
    restartScanner(); // on tente quand même de redémarrer
  });
});

    function sendCompletionEmail(orderId, email) {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', 'send_email.php', true);
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr.send('orderId=' + encodeURIComponent(orderId) + '&email=' + encodeURIComponent(email));
      xhr.onload = function () {
        try {
          const response = JSON.parse(xhr.responseText);
          alert(response.success ? 'Email envoyé avec succès !' : 'Erreur : ' + (response.error || 'inconnue'));
        } catch (e) {
          console.error('Erreur JSON :', e.message);
        }
      };
      xhr.onerror = () => console.error('Erreur AJAX');
    }

    function updateOrderCompleted(orderId, email, callback) {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', 'update_order.php', true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.send(JSON.stringify({ orderId, field: 'completed', value: 1, email }));
      xhr.onload = function () {
        try {
          const response = JSON.parse(xhr.responseText);
          if (response.success) callback();
          else alert("Erreur mise à jour commande : " + (response.message || 'Inconnue'));
        } catch (e) {
          console.error("Erreur JSON :", e.message);
        }
      };
      xhr.onerror = () => console.error("Erreur AJAX update_order");
    }
const clubArticlesConfig = {
  "ellas": ["Veste", "Pantalon", "Kit", "Bas", "Short", "Polo"],
  "union hutoise": ["Veste", "Pantalon", "Maillot", "Short", "Bas"],
  "bas-oha": ["Veste", "Pantalon", "Maillot", "Sous-maillot", "Bas", "Short", "K-Way","Bas2"],
  "rfcb sprimont": ["Veste", "Pantalon", "Maillot", "Short", "Polo", "Bas"],
  "jsn": ["Veste", "Pantalon"],
  "bas-oha": ["Veste", "Pantalon", "Maillot", "Bas"]
};

const articleValueMapping = {
  "Veste": "jacket_size",
  "Pantalon": "pants_size",
  "Kit": "kit_size",
  "Sous-maillot": "under_shirt_size",
  "Bas": "bas_size",
  "Maillot": "jersey_size",
  "Short": "short_size",
  "Polo": "polo_size",
  "K-Way": "option_kway",
  "Bas2": "option_bas",
  "Initiales": "initials_requested"
};

const roleArticlesConfig = {
  "Joueur": ["Veste", "Pantalon", "Maillot", "Short", "Bas"],
  "Joueur-WBO": ["Veste", "Pantalon", "Bas", "Sous-maillot", "Maillot", "Short", "K-Way", "Bas2"],
  "Keeper-WBO": ["Veste", "Pantalon", "Bas", "Sous-maillot", "Maillot", "Short", "K-Way", "Bas2"],
  "U10-U21": ["Veste", "Pantalon", "Polo", "Bas", "Short", "Maillot"],
  "Entraineur": ["Veste", "Pantalon", "Short", "Maillot"],
  "Ellas-Entraineur": ["Veste", "Pantalon", "Short", "Polo"],
  "Ellas-Keeper": ["Veste", "Pantalon", "Kit"],
  "Ellas-Joueur": ["Veste", "Pantalon", "Kit", "Bas"],
  "Joueur-JSN": ["Veste", "Pantalon"],
  "Entraineur-JSN": ["Veste", "Pantalon"],
  "Joueur-Hannut": ["Veste", "Pantalon", "Bas", "Maillot"],
  "Keeper-Hannut": ["Veste", "Pantalon", "Bas", "Maillot"],
};

function onScanSuccess(decodedText) {
   try {
    navigator.vibrate?.(200);

    const data = JSON.parse(decodedText);
    const { orderId, email } = data;
    if (!orderId || !email) return alert("QR Code invalide ou incomplet.");

    // ------------- NOUVEAU : Mise à jour du champ scan à 1 -------------
    fetch('update_scan.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ orderId: orderId, scan: 1 })
    }).then(res => res.json())
      .then(resp => {
        if (!resp.success) {
          console.warn('Erreur mise à jour scan:', resp.message);
          // On peut choisir de continuer quand même ou stopper ici
        }
        // Ensuite, on récupère les détails de la commande comme avant
        return fetch('get_order_details.php?orderId=' + encodeURIComponent(orderId));
      })
      .then(res => res.json())
      .then(response => {
        if (!response.success) {
          return alert("Erreur : " + response.message);
        }

        const order = response.order;
        const clubKey = order.club.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        const roleKey = order.role;
const combinedArticles = roleArticlesConfig[roleKey] || [];


        let articlesHtml = "";

        combinedArticles.forEach(label => {
  const key = articleValueMapping[label];
  let value = order[key];
  let isMissing = false;

  if (label === "K-Way") {
    value = order.option_kway || "Non";
    isMissing = order.kway_missing == 1;
  } else if (label === "Initiales") {
    value = order.initials_requested ? order.initials : "Non";
    isMissing = order.initials_missing == 1;
  } else {
    const baseKey = key.replace('_size', ''); // ex. 'pants_size' -> 'pants'
    isMissing = order[baseKey + '_missing'] == 1;
  }

  articlesHtml += renderArticle(label, value || "—", isMissing);
});



        let display = `
          <strong>${order.club}</strong><br>
          <strong>Prenom et Nom :</strong> ${order.firstname} ${order.name}<br>
          <strong>Email :</strong> ${order.email}<br>
          <strong>Téléphone :</strong> ${order.phone}<br>
          <strong>Catégorie :</strong> ${order.category}<br>
          <strong>Rôle :</strong> ${order.role}<br><br>

          <div class="articles-grid">
            ${articlesHtml}
          </div>

         
        `;

        document.getElementById('modalText').innerHTML = "";
        const container = document.createElement('div');
        container.innerHTML = display;
        document.getElementById('modalText').appendChild(container);

        currentOrderId = order.id;
        currentEmail = order.email;
        document.getElementById('confirmModal').style.display = 'flex';
		document.querySelectorAll('.article-box').forEach(box => {
  box.addEventListener('click', () => {
    const label = box.dataset.label;
    const field = articleValueMapping[label];
    const baseField = field.replace('_size', '').replace('option_', '').replace('initials_requested', 'initials');
    const missingKey = baseField + '_missing';

    // Toggle local class
    const isNowMissing = !box.classList.contains('missing');
    box.classList.toggle('missing', isNowMissing);

    // Envoie à la base de données
    const xhr = new XMLHttpRequest();
    xhr.open('POST', 'update_order.php', true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.send(JSON.stringify({
      orderId: currentOrderId,
      field: missingKey,
      value: isNowMissing ? 1 : 0
    }));

    xhr.onload = () => {
      try {
        const res = JSON.parse(xhr.responseText);
        if (!res.success) alert("Erreur mise à jour : " + (res.message || 'Inconnue'));
      } catch (e) {
        console.error("Erreur JSON réponse toggle_missing :", e);
      }
    };
    xhr.onerror = () => console.error("Erreur AJAX toggle_missing");
  });
});

      })
      .catch(err => {
        console.error("Erreur AJAX :", err);
        alert("Erreur lors de la récupération de la commande.");
      });
  } catch (err) {
    alert("QR Code invalide : JSON attendu.");
    console.error("Erreur JSON :", err);
  }
}


    const html5QrCode = new Html5Qrcode("reader");
    const config = { fps: 10 }; // PAS DE qrbox


    navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } } })
      .then(stream => {
        const track = stream.getVideoTracks()[0];
        const deviceId = track.getSettings().deviceId;
        stream.getTracks().forEach(t => t.stop());
        html5QrCode.start({ deviceId: { exact: deviceId } }, config, onScanSuccess, err => console.warn("Erreur scan :", err));
      })
      .catch(err => {
        console.error("Accès caméra refusé :", err);
        alert("Impossible d'accéder à la caméra. Vérifie les permissions.");
      });
	  
	  function restartScanner() {
  navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } } })
    .then(stream => {
      const track = stream.getVideoTracks()[0];
      const deviceId = track.getSettings().deviceId;
      stream.getTracks().forEach(t => t.stop());
      html5QrCode.start({ deviceId: { exact: deviceId } }, config, onScanSuccess, err => console.warn("Erreur scan :", err));
    })
    .catch(err => {
      console.error("Redémarrage caméra échoué :", err);
      alert("Impossible de redémarrer la caméra.");
    });
}
function renderArticle(label, size, isMissing = false) {
  return `
    <div class="article-box${isMissing ? ' missing' : ''}" data-label="${label}">
      <div class="article-label">${label}</div>
      <div class="article-size">${size}</div>
    </div>
  `;
}

function afficherArticles(order) {
  const container = document.createElement("div");
  container.style.color = "black";
  container.style.backgroundColor = "white";
  container.style.padding = "20px";

  for (const key in order) {
    if (!key.endsWith("_missing")) {
      const missingKey = `${key}_missing`;
      const isMissing = order[missingKey] == 1;

      const articleDiv = document.createElement("div");
      articleDiv.textContent = `${key} : ${order[key]}`;
      articleDiv.style.padding = "10px";
      articleDiv.style.fontSize = "2rem";
      if (isMissing) articleDiv.classList.add("missing");

      container.appendChild(articleDiv);
    }
  }

  document.body.appendChild(container); // ou dans le modal si tu préfères
}

document.getElementById('repriseBtn').addEventListener('click', () => {
  hideModal();
  html5QrCode.stop().then(() => {
    updateOrderReprise(currentOrderId, currentEmail, () => {
      alert('Commande marquée comme reprise');
      restartScanner();
    });
  }).catch(console.error);
});

function updateOrderReprise(orderId, email, callback) {
  const xhr = new XMLHttpRequest();
  xhr.open('POST', 'update_order.php', true);
  xhr.setRequestHeader('Content-Type', 'application/json');
  xhr.send(JSON.stringify({ orderId, field: 'reprise', value: 1, email }));
  xhr.onload = function () {
    try {
      const response = JSON.parse(xhr.responseText);
      if (response.success) callback();
      else alert("Erreur mise à jour commande : " + (response.message || 'Inconnue'));
    } catch (e) {
      console.error("Erreur JSON :", e.message);
    }
  };
  xhr.onerror = () => console.error("Erreur AJAX update_order");
}


  </script>
</body>
</html>
